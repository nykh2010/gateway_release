---
typora-copy-images-to: doc
---

| 发布时间   | 修改模式 | 内容         | 版本   |
| ---------- | -------- | ------------ | ------ |
| 2019-04-30 | 创建     | 总结之前版本 | v1.0.0 |
| 2019-05-07 | 修改     | 任务分配方式 | v1.0.1 |



# 一、网关系统架构

* 网关系统架构如下图所示。其中公用网关框架说明见《Iot基础框架》dma部分，以下简称iot。业务服务用于epd拉手业务，以下简称epd。串口用于与网关射频模块进行通信，以下简称serial。

![系统框架](H:\项目资料\多功能通用网关\gateway\doc\系统框架.png)

# 二、本地web服务

* 本地web服务提供功能如下表所示。web服务端口8000

| 功能           | 描述                                                         | url                   |
| -------------- | ------------------------------------------------------------ | --------------------- |
| 登录           | web页面的登录页                                              | /                     |
| 快速配置页面   | 包含wifi配置、服务器连接设置、重启网关                       | /setup                |
| 高级配置页面   | 包含修改管理密码、修改网关地址、系统升级、时间设置、恢复出厂设置、射频设置和日志查询 | /setup                |
| wifi配置       | 配置wifi热点的ssid和密码                                     | /wifi                 |
| 服务器连接设置 | 配置服务端ip和端口。连接方式：wifi或以太网。wifi连接方式下的ssid和密码 | /server               |
| 重启网关       | 重启网关                                                     | /restart              |
| 修改管理密码   | 修改登录页密码，默认密码为admin                              | /auth                 |
| 系统升级       | 升级网关应用程序                                             | /gateway/upgrade      |
| 时间设置       | 使用客户端时间或手动输入对网关进行校时                       | /gateway/upgrade/time |
| 恢复出厂设置   | 恢复出厂设置                                                 | /gateway/restore      |
| 射频设置       | 获取当前射频频点、调制方式、带宽、射频波特率；配置唤醒周期（分钟）、重发次数（次）、延时等待时间（秒）和收发模式（只收、只发、自动） | /radio/update         |
| 射频模块重启   | 重启射频模块                                                 | /radio/restart        |
| 日志查询       | 查询epd业务运行日志                                          | /log                  |



# 三、EPD业务服务

* epd业务服务对接iot平台，与serial服务进行通信，接收来自本地web端对射频模块的操作。实现功能包含任务管理、白名单管理、鉴权码管理。功能接口如下表所示。

| 上行接口功能     | 方向         | 描述                                   |
| ---------------- | ------------ | -------------------------------------- |
| 任务创建         | iot-->epd    | 服务端下发任务                         |
| 白名单下发       | iot-->epd    | 服务端更新白名单                       |
| 鉴权码下发       | iot-->epd    | 服务端更新鉴权码                       |
| 射频模块配置     | web-->epd    | 本地web配置网关射频模块                |
| 射频模块重启     | web-->epd    | 本地web重启网关射频模块                |
| **下行接口功能** |              |                                        |
| 心跳上报         | serial-->epd | 串口接收到终端心跳包                   |
| 注册上报         | serial-->epd | 串口接收到终端注册包                   |
| 终端上线         | serial-->epd | 终端连接至网关                         |
| 任务通知         | epd-->serial | 告知serial服务有新任务                 |
| 任务状态上报     | serial-->epd | serial服务告知任务执行情况             |
| 射频模块配置     | epd-->serial | 告知serial服务网关射频模块参数更新     |
| 射频模块重启     | epd-->serial | 告知serial服务重启网关射频模块         |
| 读射频模块配置   | epd-->serial | 通过serial服务获取网关射频模块当前配置 |
| **主动上报功能** |              |                                        |
| epd服务状态上报  | epd-->iot    | 上传白名单版本、任务版本和鉴权码版本   |
| 心跳上报         | epd-->iot    | 上传连接终端的基本信息                 |
| 任务执行状态上报 | epd-->iot    | 上传任务执行结果                       |

* epd服务接收来自iot的http请求，服务端口5000。业务对应http请求地址如下表所示。

| 功能名称   | 地址                |
| ---------- | ------------------- |
| 任务创建   | /task/create        |
| 白名单下发 | /gateway/white_list |
| 鉴权码下发 | /gateway/check_code |

* epd服务与serial服务使用本地Unix Socket进行通信。
* 具体协议见《内部服务api接口》

# 四、serial服务

* 见《通用网关通信协议》

# 五、部署

* 包含四个部分：iot平台、epd业务服务、serial服务、本地web服务

* ## iot平台部署

* 应用程序目录：/usr/local/bin/dma

* 配置目录：/etc/gateway/sn（网关id），/usr/local/bin/dma

* 日志存储目录：/var/logs

* ## epd业务部署

* 应用程序目录：/usr/local/bin/epd

* 配置目录：/etc/gateway

* 日志存储目录：/var/logs

* ## serial服务部署

* 应用程序目录：/usr/local/bin/serial

* 配置目录：/usr/local/bin/serial/config

* 日志存储目录：/var/logs

* ## 本地web服务部署

* 应用程序目录：/usr/local/bin/web/app

* 配置目录：/etc/gateway

* 资源文件：/usr/local/bin/web/static

* 网页模板：/usr/local/bin/web/templates

* 日志存储目录：/var/logs

# 六、其它

* ## 任务分配方式

* 流程如下图所示。
![任务分配2](H:\项目资料\多功能通用网关\gateway\doc\任务分配2.PNG)


* ## 网关校时

* 网关校时有两种方式。一种是使用服务端开启NTP服务，网关定期从NTP服务器获取时间。另一种是从本地web页面获取客户端系统时间，或手动设置。

* 